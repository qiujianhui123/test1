#include "GlobalVarShared.h"

volatile rt_uint8_t system_vol_cal;
volatile rt_uint8_t max_vol_cal;
volatile rt_uint8_t min_vol_cal;
volatile rt_uint8_t max_temp_cal;
volatile rt_uint8_t min_temp_cal;
volatile rt_uint8_t current_cal;
volatile rt_uint8_t mos_temp_cal;
rt_uint16_t conunt1 =0;//测试计数
rt_uint16_t Test_Temp = 500;

void AD_To_Temp_OutsideTotalVoltage(void);

//温度表  需与温度NTC规格书对照执行
//HKW- Z221127-01
const rt_uint16_t table_cell_shunt[256]=
{
//ADC    温度  rt
3903,	//-40	0
3892,	//-39	1
3881,	//-38	2
3869,	//-37	3
3857,	//-36	4
3844,	//-35	5
3831,	//-34	6
3817,	//-33	7
3803,	//-32	8
3788,	//-31	9
3772,	//-30	10
3756,	//-29	11
3739,	//-28	12
3722,	//-27	13
3704,	//-26	14
3685,	//-25	15
3666,	//-24	16
3646,	//-23	17
3625,	//-22	18
3604,	//-21	19
3582,	//-20	20
3559,	//-19	21
3536,	//-18	22
3512,	//-17	23
3487,	//-16	24
3462,	//-15	25
3436,	//-14	26
3409,	//-13	27
3382,	//-12	28
3354,	//-11	29
3325,	//-10	30
3295,	//-9	31
3265,	//-8	32
3235,	//-7	33
3203,	//-6	34
3172,	//-5	35
3139,	//-4	36
3106,	//-3	37
3072,	//-2	38
3038,	//-1	39
3004,	//-0	40
2968,	//1	41
2933,	//2	42
2897,	//3	43
2860,	//4	44
2823,	//5	45
2786,	//6	46
2748,	//7	47
2711,	//8	48
2672,	//9	49
2634,	//10	50
2595,	//11	51
2556,	//12	52
2517,	//13	53
2478,	//14	54
2439,	//15	55
2400,	//16	56
2360,	//17	57
2321,	//18	58
2282,	//19	59
2243,	//20	60
2203,	//21	61
2164,	//22	62
2125,	//23	63
2087,	//24	64
2048,	//25	65
2010,	//26	66
1972,	//27	67
1934,	//28	68
1896,	//29	69
1859,	//30	70
1822,	//31	71
1785,	//32	72
1749,	//33	73
1713,	//34	74
1678,	//35	75
1643,	//36	76
1609,	//37	77
1574,	//38	78
1541,	//39	79
1508,	//40	80
1475,	//41	81
1443,	//42	82
1411,	//43	83
1380,	//44	84
1349,	//45	85
1319,	//46	86
1289,	//47	87
1260,	//48	88
1232,	//49	89
1203,	//50	90
1176,	//51	91
1149,	//52	92
1122,	//53	93
1096,	//54	94
1071,	//55	95
1046,	//56	96
1021,	//57	97
997,	//58	98
974,	//59	99
951,	//60	100
928,	//61	101
906,	//62	102
885,	//63	103
864,	//64	104
843,	//65	105
823,	//66	106
804,	//67	107
784,	//68	108
766,	//69	109
747,	//70	110
730,	//71	111
712,	//72	112
695,	//73	113
679,	//74	114
662,	//75	115
646,	//76	116
631,	//77	117
616,	//78	118
601,	//79	119
587,	//80	120
573,	//81	121
559,	//82	122
546,	//83	123
533,	//84	124
520,	//85	125
508,	//86	126
496,	//87	127
484,	//88	128
473,	//89	129
462,	//90	130
451,	//91	131
440,	//92	132
430,	//93	133
420,	//94	134
410,	//95	135
401,	//96	136
391,	//97	137
382,	//98	138
373,	//99	139
365,	//100	140
356,	//101	141
348,	//102	142
340,	//103	143
332,	//104	144
325,	//105	145
317,	//106	146
310,	//107	147
303,	//108	148
296,	//109	149
290,	//110	150
283,	//111	151
277,	//112	152
271,	//113	153
265,	//114	154
259,	//115	155
253,	//116	156
247,	//117	157
242,	//118	158
237,	//119	159
231,	//120	160
226,	//121	161
222,	//122	162
217,	//123	163
212,	//124	164
207,	//125	165
203,	//126	166
199,	//127	167
194,	//128	168
190,	//129	169
186,	//130	170
182,	//131	171
179,	//132	172
175,	//133	173
171,	//134	174
168,	//135	175
164,	//136	176
161,	//137	177
157,	//138	178
154,	//139	179
151,	//140	180
148,	//141	181
145,	//142	182
142,	//143	183
139,	//144	184
136,	//145	185
134,	//146	186
131,	//147	187
128,	//148	188
126,	//149	189
123,	//150	190
0,	//151	191
0,	//152	192
0,	//153	193
0,	//154	194
0,	//155	195
0,	//156	196
0,	//157	197
0,	//158	198
0,	//159	199
0,	//160	200
0,	//161	201
0,	//162	202
0,	//163	203
0,	//164	204
0,	//165	205
0,	//166	206
0,	//167	207
0,	//168	208
0,	//169	209
0,	//170	210
0,	//171	211
0,	//172	212
0,	//173	213
0,	//174	214
0,	//175	215
0,	//176	216
0,	//177	217
0,	//178	218
0,	//179	219
0,	//180	220
0,	//181	221
0,	//182	222
0,	//183	223
0,	//184	224
0,	//185	225
0,	//186	226
0,	//187	227
0,	//188	228
0,	//189	229
0,	//190	230
0,	//191	231
0,	//192	232
0,	//193	233
0,	//194	234
0,	//195	235
0,	//196	236
0,	//197	237
0,	//198	238
0,	//199	239
0,	//200	240
0,	//201	241
0,	//202	242
0,	//203	243
0,	//204	244
0,	//205	245
0,	//206	246
0,	//207	247
0,	//208	248
0,	//209	249
0,	//210	250
0,	//211	251
0,	//212	252
0,	//213	253
0,	//214	254
0,	//215	255

};  
//HK103F4R22-1000GT01
/*const rt_uint16_t table_mos_shunt[256]=
{
3955 , 
3946 ,
3937 ,
3928 ,
3918 ,
3907 ,
3896 ,
3884 ,
3872 ,
3860 ,
3846 ,
3833 ,
3818 ,
3803 ,
3787 ,
3771 ,
3754 ,
3736 ,
3718 ,
3699 ,
3679 ,
3659 ,
3637 ,
3615 ,
3592 ,
3569 ,
3545 ,
3519 ,
3493 ,
3467 ,
3439 ,
3411 ,
3381 ,
3351 ,
3321 ,
3289 ,
3256 ,
3223 ,
3189 ,
3154 ,
3122 ,
3082 ,
3045 ,
3007 ,
2969 ,
2929 ,
2889 ,
2849 ,
2808 ,
2766 ,
2724 ,
2681 ,
2638 ,
2595 ,
2551 ,
2507 ,
2462 ,
2418 ,
2373 ,
2328 ,
2282 ,
2237 ,
2192 ,
2147 ,
2102 ,
2048 ,
2012 ,
1968 ,
1923 ,
1879 ,
1836 ,
1793 ,
1750 ,
1708 ,
1666 ,
1625 ,
1584 ,
1543 ,
1504 ,
1465 ,
1427 ,
1389 ,
1352 ,
1316 ,
1280 ,
1245 ,
1211 ,
1178 ,
1145 ,
1113 ,
1082 ,
1051 ,
1022 ,
993 ,
964 ,
937 ,
910 ,
884 ,
858 ,
834 ,
809 ,
786 ,
763 ,
741 ,
720 ,
699 ,
678 ,
659 ,
639 ,
621 ,
603 ,
586 ,
569 ,
552 ,
536 ,
521 ,
506 ,
491 ,
477 ,
464 ,
450 ,
437 ,
425 ,
413 ,
401 ,
390 ,
379 ,
368 ,
358 ,
348 ,
338 ,
329 ,
319 ,
310 ,
302 ,
294 ,
285 ,
278 ,
270 ,
263 ,
256 ,
249 ,
242 ,
235 ,
229 ,
223 ,
0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,

};*/
//二分法查表
static rt_uint16_t check_cell_shunt_tempu(rt_uint16_t h)
{
		rt_uint8_t j;
		rt_uint16_t g,g1,rt,k;

		k=128;
		rt=k;

		for(j=0;(j<10)&&(k>0);j++)
		{
				g=table_cell_shunt[rt];
				if(rt>0)
				{
						g1=table_cell_shunt[rt-1];      
				}
				else
				{
						g1=g;       
				}
				
				k=k>>1;

				if((g<h)&&(h<g1))
				{
						 rt=rt*10;
							if(rt <= 0) rt = 0;
						return rt;           
				}
				else if((g<h)&&(h>g1))
				{
						rt=rt-k; 
						if(k==1)k=2;
				 }
				else if((g>h)&&(h<g1))
				{
						rt=rt+k;
						if(k==1)k=2;
				}
				else
				{
						 rt=rt*10;
							if(rt <= 0) rt = 0;
						return rt;
				}

		}


		rt=rt*10;
		if(rt <= 0) rt = 0;
		
		return rt;
}
//二分法查表
static rt_uint16_t check_mos_shunt_tempu(rt_uint16_t h)
{
        rt_uint8_t j;
        rt_uint16_t g,g1,rt,k;
    
        k=128;
        rt=k;
  
        for(j=0;(j<10)&&(k>0);j++)
        {
                g=table_cell_shunt[rt];
                if(rt>0)
                {
                        g1=table_cell_shunt[rt-1];      
                }
                else
                {
                        g1=g;       
                }
                
                k=k>>1;
    
                if((g<h)&&(h<g1))
                {
                         rt=rt*10;
											  if(rt <= 0) rt = 0;
                        return rt;           
                }
                else if((g<h)&&(h>g1))
                {
                        rt=rt-k; 
                        if(k==1)k=2;
                 }
                else if((g>h)&&(h<g1))
                {
                        rt=rt+k;
                        if(k==1)k=2;
                }
                else
                {
                         rt=rt*10;
												if(rt<=0) rt = 0;
                        return rt;
                }

        }
  
        rt=rt*10;				
				if(rt<=0) rt = 0;
				
        return rt;
}



/*
********************************************************************************************************* 
温度ADC转换、查表、计算最大、最小、平均值
*********************************************************************************************************
*/
void AD_To_Temp_OutsideTotalVoltage(void)
{
		rt_uint8_t i,j;
		rt_uint8_t first_max=0,first_min=0,number_max=0,number_min=0;
		rt_uint16_t max_temp16=0,min_temp16=0,temperature=0;
		rt_uint32_t temp32=0;
		float Vol=0;

		if(Sys_info.member.Temp_Ad_ending)
		{				
					//屏蔽双ADC数据比较功能
//				for(i=0;i<8;i++)
//				{															
//						if(AD_Cell_Temp_Value[i] >= AD_Cell_Temp_Value_ADC2[i])
//						{
//								temp32 = AD_Cell_Temp_Value[i] - AD_Cell_Temp_Value_ADC2[i];									 
//						}									
//						else
//						{
//								temp32 = AD_Cell_Temp_Value_ADC2[i] - AD_Cell_Temp_Value[i];	
//						}
//						
//						if(temp32 > 500)	
//						{
//								Sys_info.member.Temperature_Error = 1;					
//						}
//						else
//						{
//								Sys_info.member.Temperature_Error = 0;						
//						}
//				}				
				
				//8路温度计算                                 
				for(i=0;i<8;i++)
				{									 
						temp32 = AD_Cell_Temp_Value[i];								
						temperature = check_cell_shunt_tempu(temp32); 				//温度对照表  二分法查表 -算法 																
						Sys_info.member.Cell_Temp[i] = temperature;						//正常程序		
					//if(Sys_info.member.Cell_Temp[i]>=590)
					//Sys_info.member.Cell_Temp[i]=Sys_info.member.Cell_Temp[i]+20;	
				}
					
				//计算温度最大最小值    
				for(j=0;j<8;j++)
				{                                      								
							if(first_max==0)
							{
									first_max=1;
									max_temp16=Sys_info.member.Cell_Temp[j];
									number_max=j+1;    //温度点号从1开始     
							}
							else
							{
									if(max_temp16<Sys_info.member.Cell_Temp[j])
									{
										max_temp16=Sys_info.member.Cell_Temp[j];
										number_max=j+1;       
									}
							}
															
							if(first_min==0)
							{
									first_min=1;
									min_temp16=Sys_info.member.Cell_Temp[j];
									number_min=j+1;         
							}
							else
							{
									if(min_temp16>Sys_info.member.Cell_Temp[j])
									{
											min_temp16=Sys_info.member.Cell_Temp[j];
											number_min=j+1;       
									}
							}    
								
				}
										
				Sys_info.member.Cell_Tmp_Max = max_temp16;
				Sys_info.member.Cell_Tmp_Min = min_temp16;
				Sys_info.member.Cell_Tmp_Max_num = number_max; 
				Sys_info.member.Cell_Tmp_Min_num = number_min; 
			 
				//测试代码
//				Sys_info.member.Cell_Tmp_Min = Test_Temp;
				//计算最大最小值温差        
				if(max_temp16>min_temp16)
				{
						Sys_info.member.Cell_Tmp_Deff=max_temp16-min_temp16;      
				}
				else
				{
						Sys_info.member.Cell_Tmp_Deff=0;      
				}
				
				max_temp_cal = 1;
				min_temp_cal = 1;								
						
				//计算MOS温度						
				temp32=AD_MOS_Temp_Value;																																	
				temperature=check_mos_shunt_tempu(temp32); //温度对照表  二分法查表 -算法 														
				Sys_info.member.Mos_Temp=temperature;
				mos_temp_cal=1;													
				
				Sys_info.member.Temp_Ad_ending=0; 
						
						
				//计算外部总压  100ms/次
				Vol=AD_Total_Voltage_Value;
				Vol=Vol*3.3;
				Vol=Vol/4095;
				Vol=10*Vol/0.05;
				Sys_info.member.Pack_Voltage = Vol;							
			}		
}



//----------------------------------------------------------无下文---------------------------------------------------------------------------------

