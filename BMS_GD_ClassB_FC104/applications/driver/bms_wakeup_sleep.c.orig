
#include <rtthread.h>
#include "bms_wakeup_sleep.h"

rt_uint8_t	start_flag;

//ç³»ç»Ÿè¿›å…¥å¾…æœºæ¨¡å¼
void Sys_Enter_Standby(void)
{
    //__HAL_RCC_AHB1_FORCE_RESET();       //å¤ä½æ‰€æœ‰IOå£ 
	   
		__HAL_RCC_PWR_CLK_ENABLE();         //ä½¿èƒ½PWRæ—¶é’Ÿ    
    __HAL_PWR_CLEAR_FLAG(PWR_FLAG_WU);                  //æ¸…é™¤Wake_UPæ ‡å¿—		
    HAL_PWR_EnableWakeUpPin(PWR_WAKEUP_PIN1);           //è®¾ç½®WKUPç”¨äºå”¤é†’
    HAL_PWR_EnterSTANDBYMode();                         //è¿›å…¥å¾…æœºæ¨¡å¼     
}


// å”¤é†’æŒ‰é”®åˆå§‹åŒ–
void WAKEUP_Init(void)
{
	GPIO_InitTypeDef GPIO_Initure; // å®šä¹‰åˆå§‹åŒ–GPIOç»“æ„ä½“å˜é‡
	__HAL_RCC_GPIOA_CLK_ENABLE(); // å¼€å§‹GPIOAæ—¶é’Ÿ
	
	GPIO_Initure.Pin = GPIO_PIN_0; // PA0å¼•è„š
	GPIO_Initure.Pull = GPIO_PULLDOWN; // ä¸Šæ‹‰
	GPIO_Initure.Mode = GPIO_MODE_IT_RISING; // ä¸‹é™æ²¿è§¦å‘
	GPIO_Initure.Speed = GPIO_SPEED_FREQ_HIGH; // é«˜é€Ÿ
	HAL_GPIO_Init(GPIOA, &GPIO_Initure); // GPIOEåˆå§‹åŒ–
		
	HAL_NVIC_SetPriority(EXTI0_IRQn, 2, 2);
	HAL_NVIC_EnableIRQ(EXTI0_IRQn);
	
	//æ£€æŸ¥æ˜¯å¦æ˜¯æ­£å¸¸å¼€æœº
	if(Check_WKUP()==0)
	{
			Sys_Enter_Standby();//ä¸æ˜¯å¼€æœºï¼Œè¿›å…¥å¾…æœºæ¨¡å¼
	}
}

//æ£€æµ‹WKUPè„šçš„ä¿¡å·
//è¿”å›å€¼1:è¿ç»­æŒ‰ä¸‹3sä»¥ä¸Š
//      0:é”™è¯¯çš„è§¦å‘	
rt_uint8_t Check_WKUP(void) 
{
	rt_uint8_t t=0;
	rt_uint8_t tx=0;//è®°å½•æ¾å¼€çš„æ¬¡æ•°

	while(1)
	{
		if(WKUP_KD)//å·²ç»æŒ‰ä¸‹äº†
		{
			t++;
			tx=0;
		}else 
		{
			t=0;
			tx++; 
			if(tx>3)//è¶…è¿‡90mså†…æ²¡æœ‰WKUPä¿¡å·
			{
				return 0;//é”™è¯¯çš„æŒ‰é”®,æŒ‰ä¸‹æ¬¡æ•°ä¸å¤Ÿ
			}
		}
		rt_thread_mdelay(30);
<<<<<<< HEAD

		if(t>=100)//°´ÏÂ³¬¹ı3ÃëÖÓ
=======
		if(t>=100)//æŒ‰ä¸‹è¶…è¿‡3ç§’é’Ÿ
>>>>>>> 1d7f8c05df331ee1795f109347ee4ace751fc8f5
		{
			return 1; //æŒ‰ä¸‹3sä»¥ä¸Šäº†
		}
	}
}  


//å¤–éƒ¨ä¸­æ–­çº¿0ä¸­æ–­æœåŠ¡å‡½æ•°
void EXTI0_IRQHandler(void)
{
    HAL_GPIO_EXTI_IRQHandler(GPIO_PIN_0);
}

//ä¸­æ–­çº¿0ä¸­æ–­å¤„ç†è¿‡ç¨‹
//æ­¤å‡½æ•°ä¼šè¢«HAL_GPIO_EXTI_IRQHandler()è°ƒç”¨
//GPIO_Pin:å¼•è„š
void HAL_GPIO_EXTI_Callback(uint16_t GPIO_Pin)
{
    if(GPIO_Pin==GPIO_PIN_0)//PA0
    {
			start_flag = 1;
    }    
}

